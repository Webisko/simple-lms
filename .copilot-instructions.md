# SimpleLMS - GitHub Copilot Context

## Project Overview

**Simple LMS** is a WordPress Learning Management System plugin with:
- Hierarchical course structure (Course → Module → Lesson)
- WooCommerce integration for course sales
- Elementor & Bricks Builder widgets
- Tag-based access control (user_meta)
- Drip content scheduling
- Progress tracking
- REST API
- Multilingual support (Polish, English, German)

---

## Technical Stack

- **PHP:** 7.4+ (target 8.0+)
- **WordPress:** 6.0+
- **WooCommerce:** 7.0+ (optional integration)
- **Elementor:** 3.5+ (optional)
- **Bricks Builder:** 1.5+ (optional)
- **Standards:** PSR-12, WordPress Coding Standards

---

## Namespace & Structure

### Core Namespace
```php
namespace SimpleLMS;
```

### Directory Structure
```
simple-lms/
├── includes/                  # Core PHP classes
│   ├── class-*.php           # Main classes (CamelCase)
│   ├── access-control.php    # Helper functions
│   ├── elementor-dynamic-tags/
│   │   ├── widgets/          # Elementor widgets
│   │   └── tags/             # Dynamic tags
│   └── bricks/
│       └── elements/         # Bricks elements
├── assets/
│   └── src/
│       ├── css/              # Stylesheets
│       └── js/               # JavaScript
├── languages/                # Translations (.po, .mo)
└── tests/                    # PHPUnit tests
```

---

## Coding Standards

### PHP

**1. Always Use Namespace:**
```php
<?php
namespace SimpleLMS;

// NOT: class My_Class
// YES: class MyClass
```

**2. Escape ALL Output:**
```php
// Text
echo esc_html( $text );

// Attributes
echo '<div class="' . esc_attr( $class ) . '">';

// URLs
echo '<a href="' . esc_url( $url ) . '">';

// Rich HTML (allowed tags)
echo wp_kses_post( $content );
```

**3. Sanitize ALL Input:**
```php
// Text fields
$title = sanitize_text_field( $_POST['title'] );

// Integers
$course_id = absint( $_POST['course_id'] );

// Emails
$email = sanitize_email( $_POST['email'] );

// URLs
$url = esc_url_raw( $_POST['url'] );

// Verify nonces
if ( ! wp_verify_nonce( $_POST['nonce'], 'action_name' ) ) {
    wp_die( 'Security check failed' );
}
```

**4. Function Documentation (PHPDoc):**
```php
/**
 * Check if user has access to course
 *
 * @param int $user_id User ID
 * @param int $course_id Course ID
 * @return bool True if user has access
 */
function simple_lms_user_has_course_access( $user_id, $course_id ) {
    $access = (array) get_user_meta( $user_id, 'simple_lms_course_access', true );
    return in_array( $course_id, $access, true );
}
```

**5. Error Handling:**
```php
// Check for errors
if ( is_wp_error( $result ) ) {
    error_log( 'SimpleLMS Error: ' . $result->get_error_message() );
    return false;
}

// Validate post type
if ( get_post_type( $post_id ) !== 'course' ) {
    return new \WP_Error( 'invalid_post_type', __( 'Invalid post type', 'simple-lms' ) );
}
```

---

## Access Control System

### Tag-Based Access (NOT Roles!)

**User Meta Key:**
```php
'simple_lms_course_access' // Array of course IDs
```

**Helper Functions:**
```php
// Check access
simple_lms_user_has_course_access( $user_id, $course_id );

// Grant access
simple_lms_assign_course_access( $user_id, $course_id );

// Remove access
simple_lms_remove_course_access( $user_id, $course_id );
```

**Example Usage:**
```php
$user_id = get_current_user_id();
$course_id = get_the_ID();

if ( ! simple_lms_user_has_course_access( $user_id, $course_id ) ) {
    echo '<p>' . esc_html__( 'You do not have access to this course.', 'simple-lms' ) . '</p>';
    return;
}

// Show course content...
```

**WooCommerce Integration:**
- On order complete → `simple_lms_assign_course_access()`
- On order refund/cancel → `simple_lms_remove_course_access()`

---

## Internationalization (i18n)

### Text Domain
```php
'simple-lms'
```

### Translation Functions
```php
// Simple string
__( 'Text', 'simple-lms' );

// Echo string
_e( 'Text', 'simple-lms' );

// With context
_x( 'Post', 'noun', 'simple-lms' );

// Plural
_n( '%s course', '%s courses', $count, 'simple-lms' );

// Escaped
esc_html__( 'Text', 'simple-lms' );
esc_attr__( 'Text', 'simple-lms' );
```

### Supported Languages
- **Polish** (`pl_PL`)
- **English** (`en_US`)
- **German** (`de_DE`)

---

## Elementor Widget Template

```php
<?php
namespace SimpleLMS;

use Elementor\Widget_Base;
use Elementor\Controls_Manager;

class My_Widget extends Widget_Base {
    
    public function get_name() {
        return 'simple_lms_my_widget';
    }
    
    public function get_title() {
        return __( 'My Widget', 'simple-lms' );
    }
    
    public function get_icon() {
        return 'eicon-posts-grid';
    }
    
    public function get_categories() {
        return [ 'simple-lms' ];
    }
    
    protected function register_controls() {
        $this->start_controls_section(
            'content_section',
            [
                'label' => __( 'Content', 'simple-lms' ),
                'tab' => Controls_Manager::TAB_CONTENT,
            ]
        );
        
        $this->add_control(
            'course_id',
            [
                'label' => __( 'Course ID', 'simple-lms' ),
                'type' => Controls_Manager::NUMBER,
                'default' => 0,
            ]
        );
        
        $this->end_controls_section();
    }
    
    protected function render() {
        $settings = $this->get_settings_for_display();
        $course_id = absint( $settings['course_id'] );
        
        if ( ! $course_id ) {
            $course_id = get_the_ID();
        }
        
        // Validate
        if ( ! $course_id || get_post_type( $course_id ) !== 'course' ) {
            echo '<p>' . esc_html__( 'Invalid course.', 'simple-lms' ) . '</p>';
            return;
        }
        
        // Check access
        $user_id = get_current_user_id();
        if ( ! simple_lms_user_has_course_access( $user_id, $course_id ) ) {
            echo '<p>' . esc_html__( 'No access.', 'simple-lms' ) . '</p>';
            return;
        }
        
        // Render content
        ?>
        <div class="simple-lms-widget">
            <?php // Your HTML here ?>
        </div>
        <?php
    }
}
```

---

## Bricks Element Template

```php
<?php
namespace SimpleLMS;

class My_Element extends \Bricks\Element {
    
    public $category = 'simple-lms';
    public $name = 'simple-lms-my-element';
    public $icon = 'ti-layout';
    
    public function get_label() {
        return esc_html__( 'My Element', 'simple-lms' );
    }
    
    public function set_controls() {
        $this->controls['course_id'] = [
            'tab' => 'content',
            'label' => esc_html__( 'Course ID', 'simple-lms' ),
            'type' => 'number',
            'default' => 0,
        ];
    }
    
    public function render() {
        $settings = $this->settings;
        $course_id = isset( $settings['course_id'] ) ? absint( $settings['course_id'] ) : 0;
        
        if ( ! $course_id ) {
            $course_id = get_the_ID();
        }
        
        // Validate & check access (same as Elementor)
        
        // Render
        echo '<div ' . $this->render_attributes( '_root' ) . '>';
        // Your content
        echo '</div>';
    }
}
```

---

## AJAX Handler Template

```php
public static function ajax_my_action() {
    // Verify nonce
    check_ajax_referer( 'simple_lms_nonce', 'nonce' );
    
    // Check permissions
    if ( ! current_user_can( 'read' ) ) {
        wp_send_json_error( [
            'message' => __( 'Permission denied', 'simple-lms' )
        ] );
    }
    
    // Sanitize input
    $course_id = isset( $_POST['course_id'] ) ? absint( $_POST['course_id'] ) : 0;
    
    if ( ! $course_id ) {
        wp_send_json_error( [
            'message' => __( 'Invalid course ID', 'simple-lms' )
        ] );
    }
    
    // Do work
    $result = do_something( $course_id );
    
    if ( is_wp_error( $result ) ) {
        wp_send_json_error( [
            'message' => $result->get_error_message()
        ] );
    }
    
    wp_send_json_success( [
        'message' => __( 'Success!', 'simple-lms' ),
        'data' => $result
    ] );
}
```

---

## REST API Endpoints

### Base URL
```
/wp-json/simple-lms/v1/
```

### Common Endpoints
- `GET /courses` - List courses
- `GET /courses/{id}` - Get course
- `GET /courses/{id}/modules` - Get modules
- `GET /courses/{id}/progress` - User progress
- `POST /progress/complete` - Mark lesson complete

### Permission Callback
```php
'permission_callback' => function() {
    return current_user_can( 'read' );
}
```

---

## Database Queries

### Get Course Modules
```php
$modules = get_posts( [
    'post_type' => 'module',
    'post_parent' => $course_id,
    'posts_per_page' => -1,
    'orderby' => 'menu_order',
    'order' => 'ASC',
    'post_status' => 'publish'
] );
```

### Get User Progress
```php
$completed = get_user_meta( $user_id, 'simple_lms_completed_lessons', true );
if ( ! is_array( $completed ) ) {
    $completed = [];
}
```

### Caching Pattern
```php
$cache_key = 'simple_lms_course_modules_' . $course_id;
$modules = wp_cache_get( $cache_key );

if ( false === $modules ) {
    $modules = get_posts( [...] );
    wp_cache_set( $cache_key, $modules, '', 3600 );
}
```

---

## Common Pitfalls to Avoid

❌ **DON'T:**
- Use WordPress roles for course access (use user_meta tags)
- Forget to escape output
- Forget to sanitize input
- Use global namespace (always use `SimpleLMS\`)
- Hardcode text (always use `__()` / `_e()`)
- Skip nonce verification in AJAX
- Use `$_GET` / `$_POST` directly without sanitization
- Query without caching for repeated calls

✅ **DO:**
- Use `simple_lms_user_has_course_access()` for access checks
- Always escape: `esc_html()`, `esc_attr()`, `esc_url()`
- Always sanitize: `sanitize_text_field()`, `absint()`
- Use namespace: `namespace SimpleLMS;`
- Translate strings: `__( 'Text', 'simple-lms' )`
- Verify nonces: `wp_verify_nonce()`
- Check capabilities: `current_user_can()`
- Cache queries: `wp_cache_get/set()`

---

## Performance Best Practices

1. **Cache Heavy Queries:**
   - Course structure (modules/lessons)
   - User progress data
   - Access control checks

2. **Lazy Load Assets:**
   - Enqueue scripts only on relevant pages
   - Use `wp_enqueue_script()` with dependencies

3. **Optimize Database:**
   - Use `posts_per_page` limits
   - Index custom meta keys if querying often

4. **Avoid N+1 Queries:**
   - Use `get_posts()` with `post__in` instead of loops
   - Cache results for repeated access

---

## Testing Checklist

When creating new features, always test:
- [ ] Works on Firefox & Chrome
- [ ] No JavaScript console errors
- [ ] No PHP warnings in debug.log
- [ ] Responsive (mobile/tablet/desktop)
- [ ] Access control enforced
- [ ] Translations working (PL/EN)
- [ ] Elementor/Bricks widgets render
- [ ] WooCommerce integration (if applicable)

---

## Git Commit Format

```
type(scope): subject

body

footer
```

**Types:**
- `feat` - New feature
- `fix` - Bug fix
- `docs` - Documentation
- `style` - Formatting
- `refactor` - Code refactor
- `perf` - Performance improvement
- `test` - Tests
- `chore` - Maintenance

**Example:**
```
feat(widgets): add lesson calendar widget

- Display lesson unlock dates
- Show completion status icons
- Responsive grid layout
- Polish/English support
```

---

## Need Help?

- **Documentation:** See `API-REFERENCE.md`, `ARCHITECTURE.md`, `HOOKS.md`
- **Examples:** Check existing widgets in `includes/elementor-dynamic-tags/widgets/`
- **Testing:** Run `composer test` (if composer configured)
- **Issues:** Open issue on GitHub

---

**Last Updated:** January 15, 2026
